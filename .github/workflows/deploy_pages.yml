name: Deploy Pages
on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - uses: actions/checkout@v3
      - name: Fetch all available Playwright reports
        shell: bash {0}
        env:
          E2E_PATH: gh-pages/artifacts/e2e-tests
        run: |
          gh run list \
              --branch main  \
              --status completed \
              --workflow "Playwright Tests" \
              --json databaseId,displayTitle \
          | jq -c '.[]' \
          | while read object; do
              databaseId=$(echo "$object" | jq -r '.databaseId')
              displayTitle=$(echo "$object" | jq -r '.displayTitle')

              filename="${databaseId}-${displayTitle// /-}"
              directory="${E2E_PATH}/${filename:0:60}"
              directory=$(echo "$directory" | sed -E 's/[^[:alnum:]_-]+/-/g')

              echo $directory
              gh run download "$databaseId" -D "$directory" -n playwright-report
              echo
          done
      - name: Generate index for artifacts
        working-directory: ./gh-pages/artifacts
        run: tree -L 2 -P '**/' -r -H . -T artifacts -o index.html
      - name: Upload GH Pages artifact
        uses: actions/upload-pages-artifact@v1
        with:
          path: gh-pages

  deploy:
    environment:
        name: github-pages
        url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
